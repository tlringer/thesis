\chapter{Proof Repair Across Type Equivalences}
\label{chapt:pi}

% From PUMPKIN Pi intro, modified

This chapter presents the \toolnamec extension to the \sysnamelong proof repair plugin suite for Coq 8.8 % TODO 8.9.1 etc
that is available on Github.\footnote{I annotate each claim to which code is relevant with a circled number like \circled{1}. These circled numbers are links to code, and are detailed in \href{https://github.com/uwplse/pumpkin-pi/blob/v2.0.0/GUIDE.md}{\lstinline{GUIDE.md}}.} % TODO update links
\toolnamec is a plugin that adds support for proof repair across a broad class of changes in datatypes called 
\textit{type equivalences} (Section~\ref{sec:pi-scope}),
thereby supporting a large class of practical repair scenarios.
Proof repair across type equivalences with \toolnamec makes progress on two challenges that the \sysname prototype had left open:

\begin{enumerate}
\item \sysname supported a very limited classes of changes in datatypes, namely those that do not change structure.
Similar tools developed since still supported only a predefined set of changes~\cite{robert2018, wibergh2019}. As my user study showed, none of these were informed by the current needs of proof engineers. %~\cite{replica}. TODO elaborate?
\item \sysname had only preliminary integration with typical proof engineering workflows.
Similar tools developed since likewise lacked support for workflow integration~\cite{PGL-045, robert2018},
and in some cases imposed additional proof obligations like proving relations corresponding to changes~\cite{tabareau2019marriage}.
\end{enumerate}

\paragraph{Addressing Challenge 1: Flexible Type Support}
The case studies in Section~\ref{sec:pi-results}---summarized in Table~\ref{fig:changes} on page~\pageref{fig:changes}---show that \toolnamec is flexible enough to support
a wide range of proof engineering use cases. % can support a flexible class of changes informed by the needs of proof engineers within a unified framework.
In general, \toolnamec can support any change described by an equivalence, though it takes the equivalence in a
deconstructed form---the \textit{configuration} for \toolnamec. % TODO overloaded
The configuration expresses to the proof term transformation how to translate functions and proofs defined over the old version of a type
to refer only to the new version, and how to do so in a way that does not break definitional equality.
The proof engineer can write this configuration in Coq and feed it to \toolname (\textit{manual configuration} in Table~\ref{fig:changes}),
configuring \toolname to support the change. %from directly within Coq.

\paragraph{Addressing Challenge 2: Workflow Integration}
Research on workflow integration for proof repair tools is in its infancy.
\toolnamec is built with workflow integration in mind.
For example, \toolnamec is the only proof repair tool I am aware of that produces suggested proof scripts (rather than proof terms) for repaired proofs,
a challenge highlighted in the previous chapter, in other existing proof repair work~\cite{robert2018}, and in 
my survey of proof engineering~\cite{PGL-045}.
In addition, \toolnamec implements search procedures that 
automatically discover configurations and prove the equivalences they induce for four different classes of 
changes (\textit{automatic configuration} in Table~\ref{fig:changes}),
decreasing the burden of proof obligations imposed on the proof engineer.
My partnership with an industrial proof engineer has informed other changes to further improve workflow integration
(Sections~\ref{sec:pi-implementation} and~\ref{sec:pi-results}).

\paragraph{Bringing it Together}
In the frame of the thesis, proof repair across type equivalences is a new form of proof automation that extracts general information from breaking 
changes in the datatypes that programs, specifications, and proofs refer to, 
then applies that information to fix any program, specification, or proof broken by that change (Section~\ref{sec:pi-approach}).
This extraction, generalization, and application works at the level of proof terms, through a combination of novel semantic differencing algorithms over datatypes (Section~\ref{sec:pi-diff}) and a configurable proof term transformation (Section~\ref{sec:pi-trans}).
\toolnamec automates this process,
with additional support for manual configuration by proof engineers and for integration with 
typical proof engineering workflows (Section~\ref{sec:pi-implementation}).
Case studies show that \toolnamec can save and in several cases \textit{has} saved work for proof engineers on major proof developments and on
changes that matter (Section~\ref{sec:pi-results}).

\input{often/motivating}

\input{often/approach}

\input{often/differencing}

\input{often/transformation}

\input{often/implementation}

\input{often/results}

\input{often/conclusion}

